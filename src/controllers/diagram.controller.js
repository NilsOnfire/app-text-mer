const e = require('express');
const { ChatGPT } = require('../utils/diagram');
const { splitMermaidObject, getEntitiesWithAttribs, getRelations } = require('../utils/converter');

/**
 * 
 * @param {e.Request} req 
 * @param {e.Response} res 
 */
exports.generateDiagram = (req, res) => {
    //parsed into text plain
    const input = req.body;
    const chat = new ChatGPT();

    let prompt = chat.generatePrompt(input);

    // asyncronic function  to wait the result generated by gpt
    const chapGPT = async (stm, prompt) => {
        // Chat-gpt connection

        const openai = chat.getOpenAI();

        const response = await openai.createChatCompletion({
            model: "gpt-3.5-turbo",
            messages: [{ role: "user", content: prompt }],
        });

        //Get data generated by chatgpt from prompt

        let completion = response["data"]["choices"][0]["message"]["content"].toString();

        //converting to js object
        const objectMer = JSON.parse(completion);

        const { listOfRels, listOfEntities } = splitMermaidObject(objectMer);

        //functions to convert data in mermaid code ER format
        let entities = getEntitiesWithAttribs(objectMer, listOfEntities);
        let rels = getRelations(objectMer, listOfRels);
        completion = entities + "\n" + rels;

        var data = { texts: { resp: completion, title: "TextMer", stm } };
        console.log(typeof completion);
        res.status(200).json({ response: data });
    };

    chapGPT(input, prompt);
};